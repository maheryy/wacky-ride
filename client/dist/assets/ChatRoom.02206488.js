import{f as A,h as M,g as V,u as S,y as x,o as c,c as m,a as t,A as k,I as D,p as C,q as j,x as I,H as z,m as B,C as E,n as L,r as N,b as T,w as K,d as U,F as q,z as F,D as H,k as Z,v as G,E as J,s as O,t as P,_ as Q}from"./index.4ddf9c97.js";import{d as R}from"./dayjs.min.203e8904.js";const W={class:"message"},X={class:"message__content"},Y={class:"message__meta"},ee={key:0,class:"message__meta__date"},se=A({__name:"RoomMessage",props:{message:null},setup(e){const i=e,l=M(),v=V(),f=v.socket,y=S(),r=o=>{const n=new Date(o),u=n.getHours(),h=n.getMinutes(),a=s=>s<10?"0"+s:s;return`${a(u)}:${a(h)}`},p=x(()=>{var o;return i.message.author.isAdmin?!1:((o=v.user)==null?void 0:o.id)!==i.message.author.id});function w(o){!p.value||(f.emit("conversation:conversate",+o),f.once("conversation",({data:n,errors:u})=>{if(u){for(const h of u)l.error(h.message);return}y.push({name:"conversation",params:{conversationId:n.conversation.id}})}))}return(o,n)=>(c(),m("li",W,[t("div",X,k(e.message.content),1),t("div",Y,[t("span",{class:D({message__meta__user:!0,talkableUser:C(p)}),onClick:n[0]||(n[0]=u=>w(e.message.author.id))},k(e.message.author.username)+" "+k(e.message.author.isAdmin?"(Conseiller)":""),3),e.message.createdAt?(c(),m("span",ee,k(r(e.message.createdAt)),1)):j("",!0)])]))}});const b=e=>(O("data-v-e300d831"),e=e(),P(),e),te={class:"main-container wacky-tile"},oe={id:"room",class:"community"},ae=b(()=>t("p",{class:"text-gray-600 text-center italic text-sm"},"Cliquez sur un utilisateur pour lancer une conversation priv\xE9e",-1)),ne={key:0,class:"messages"},re={key:1,class:"no-messages"},ce=b(()=>t("p",null,"Il n'y a pas de messages",-1)),ie=[ce],ue={key:2,class:"board"},me=["onKeyup"],le={key:3,class:"can-not-send-message"},de=b(()=>t("p",null,"Vous ne pouvez envoyer de messages",-1)),_e=[de],ge=A({__name:"ChatRoom",props:{roomId:null},setup(e){const{roomId:i}=e,l=I(""),v=z(),f=V(),y=M(),r=f.socket,p=x(()=>v.rooms[i]),w=x(()=>{var a;return((a=p.value)==null?void 0:a.messages)||[]}),o=I(null),n=I(!1),u=x(()=>w.value.slice().sort((a,s)=>R(a.createdAt).isAfter(R(s.createdAt))?1:-1)),h=()=>{!l.value||(r.emit("room:message:send",+i,l.value),l.value="")};return B(()=>{var a;(a=o.value)==null||a.scrollIntoView({block:"end"}),r.emit("room:join",+i),r.on("room:joined",({data:s,errors:d})=>{if(d){for(const _ of d)y.error(_.message);return}n.value=!0,v.updateRoom(s.room)}),r.on("room:message:received",async({data:s,errors:d})=>{var _,g;if(d){for(const $ of d)y.error($.message);return}v.addMessage(i,s.message),s.message.author.id===((_=f.user)==null?void 0:_.id)&&(await E(),(g=o.value)==null||g.scrollIntoView({block:"end"}))})}),L(()=>{r.emit("room:leave",+i),r.off("room:joined"),r.off("room:message:received")}),(a,s)=>{var _;const d=N("RouterLink");return c(),m("div",te,[t("section",oe,[t("header",null,[T(d,{to:"/rooms",class:"back"},{default:K(()=>[U("\u1438")]),_:1}),t("h3",null,k((_=C(p))==null?void 0:_.name),1)]),ae,C(u).length?(c(),m("ul",ne,[(c(!0),m(q,null,F(C(u),g=>(c(),H(se,{key:g.id,message:g},null,8,["message"]))),128)),t("div",{ref_key:"bottom",ref:o,class:"bottom"},null,512)])):(c(),m("div",re,ie)),n.value?(c(),m("div",ue,[Z(t("input",{type:"text","onUpdate:modelValue":s[0]||(s[0]=g=>l.value=g),onKeyup:J(h,["enter"]),autofocus:"",maxlength:"255",minlength:"1"},null,40,me),[[G,l.value,void 0,{trim:!0}]]),t("button",{onClick:h},"Envoyer")])):(c(),m("div",le,_e))])])}}});const fe=Q(ge,[["__scopeId","data-v-e300d831"]]);export{fe as default};
